var mongoose = require('mongoose');
var bike = require('config/bikemodels');
var fs = require('fs');
var Q  = require('q');
function CheckOut(bodytest,imagetest,cb) {
	var deferred = Q.defer();
	deferred.notify(bodytest);
	if(/^[\u4e00-\u9fa5]+$/.test(bodytest.name)) {
		if(/^[0-9]{11}$/.test(bodytest.username)) {
			if(/^[0-9]{11}$/.test(bodytest.phone)) {
				upload(bodytest, imagetest);
				new cb('成功上传');
				deferred.resolve();
			}else deferred.reject(new Error('请检查电话!'));
		}else deferred.reject(new Error('请检查学号!'));
	}deferred.reject(new Error('请检查姓名!'));
	return deferred.promise.nodeify(cb);
}

exports.CheckOut = CheckOut;
function upload(bikeInfo, image) {
	var info = bikeInfo;
	var newBike = new bike;
	newBike.name = info.name;
	newBike.username = info.username;
	newBike.phone = info.phone;
	newBike.address = info.address;
	newBike.brand = info.brand;
	newBike.zone = info.zone;
	newBike.image.data = fs.readFileSync(image.path);
	newBike.image.contentType = image.type; 
	newBike.save();
}
exports.upload = upload;
/*exports.upload = function(bikeInfo, image, callback) {
	var info = bikeInfo;
	var newBike = new bike;
	newBike.name = info.name;
	newBike.username = info.username;
	newBike.phone = info.phone;
	newBike.address = info.address;
	newBike.brand = info.brand;
	newBike.zone = info.zone;
	newBike.image.data = fs.readFileSync(image.path);
	newBike.image.contentType = image.type; 
	newBike.save(function(err){
		callback({"response": "Sucessfully Upload"});
	});
}*/